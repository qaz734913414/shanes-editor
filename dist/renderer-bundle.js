!function(e){var t={};function i(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(r,a,function(t){return e[t]}.bind(null,a));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=55)}({0:function(e,t,i){"use strict";i.d(t,"a",function(){return r});class r{capFirst(e){return(e||"").charAt(0).toUpperCase()+(e||"").slice(1)}getRandomInt(e,t){return Math.floor(Math.random()*(t-e))+e}generateName(){var e=["abandoned","able","absolute","adorable","adventurous","academic","acceptable","acclaimed","accomplished","accurate","aching","acidic","acrobatic","active","actual","adept","admirable","admired","adolescent","adorable","adored","advanced","afraid","affectionate","aged","aggravating","aggressive","agile","agitated","agonizing","agreeable","ajar","alarmed","alarming","alert","alienated","alive","all","altruistic","amazing","ambitious","ample","amused","amusing","anchored","ancient","angelic","angry","anguished","animated","annual","another","antique","anxious","any","apprehensive","appropriate","apt","arctic","arid","aromatic","artistic","ashamed","assured","astonishing","athletic","attached","attentive","attractive","austere","authentic","authorized","automatic","avaricious","average","aware","awesome","awful","awkward","babyish","bad","back","baggy","bare","barren","basic","beautiful","belated","beloved","beneficial","better","best","bewitched","big","big-hearted","biodegradable","bite-sized","bitter","black","black-and-white","bland","blank","blaring","bleak","blind","blissful","blond","blue","blushing","bogus","boiling","bold","bony","boring","bossy","both","bouncy","bountiful","bowed","brave","breakable","brief","bright","brilliant","brisk","broken","bronze","brown","bruised","bubbly","bulky","bumpy","buoyant","burdensome","burly","bustling","busy","buttery","buzzing","calculating","calm","candid","canine","capital","carefree","careful","careless","caring","cautious","cavernous","celebrated","charming","cheap","cheerful","cheery","chief","chilly","chubby","circular","classic","clean","clear","clear-cut","clever","close","closed","cloudy","clueless","clumsy","cluttered","coarse","cold","colorful","colorless","colossal","comfortable","common","compassionate","competent","complete","complex","complicated","composed","concerned","concrete","confused","conscious","considerate","constant","content","conventional","cooked","cool","cooperative","coordinated","corny","corrupt","costly","courageous","courteous","crafty","crazy","creamy","creative","creepy","criminal","crisp","critical","crooked","crowded","cruel","crushing","cuddly","cultivated","cultured","cumbersome","curly","curvy","cute","cylindrical","damaged","damp","dangerous","dapper","daring","darling","dark","dazzling","dead","deadly","deafening","dear","dearest","decent","decimal","decisive","deep","defenseless","defensive","defiant","deficient","definite","definitive","delayed","delectable","delicious","delightful","delirious","demanding","dense","dental","dependable","dependent","descriptive","deserted","detailed","determined","devoted","different","difficult","digital","diligent","dim","dimpled","dimwitted","direct","disastrous","discrete","disfigured","disgusting","disloyal","dismal","distant","downright","dreary","dirty","disguised","dishonest","dismal","distant","distinct","distorted","dizzy","dopey","doting","double","downright","drab","drafty","dramatic","dreary","droopy","dry","dual","dull","dutiful","each","eager","earnest","early","easy","easy-going","ecstatic","edible","educated","elaborate","elastic","elated","elderly","electric","elegant","elementary","elliptical","embarrassed","embellished","eminent","emotional","empty","enchanted","enchanting","energetic","enlightened","enormous","enraged","entire","envious","equal","equatorial","essential","esteemed","ethical","euphoric","even","evergreen","everlasting","every","evil","exalted","excellent","exemplary","exhausted","excitable","excited","exciting","exotic","expensive","experienced","expert","extraneous","extroverted","extra-large","extra-small","fabulous","failing","faint","fair","faithful","fake","false","familiar","famous","fancy","fantastic","far","faraway","far-flung","far-off","fast","fat","fatal","fatherly","favorable","favorite","fearful","fearless","feisty","feline","female","feminine","few","fickle","filthy","fine","finished","firm","first","firsthand","fitting","fixed","flaky","flamboyant","flashy","flat","flawed","flawless","flickering","flimsy","flippant","flowery","fluffy","fluid","flustered","focused","fond","foolhardy","foolish","forceful","forked","formal","forsaken","forthright","fortunate","fragrant","frail","frank","frayed","free","French","fresh","frequent","friendly","frightened","frightening","frigid","frilly","frizzy","frivolous","front","frosty","frozen","frugal","fruitful","full","fumbling","functional","funny","fussy","fuzzy","gargantuan","gaseous","general","generous","gentle","genuine","giant","giddy","gigantic","gifted","giving","glamorous","glaring","glass","gleaming","gleeful","glistening","glittering","gloomy","glorious","glossy","glum","golden","good","good-natured","gorgeous","graceful","gracious","grand","grandiose","granular","grateful","grave","gray","great","greedy","green","gregarious","grim","grimy","gripping","grizzled","gross","grotesque","grouchy","grounded","growing","growling","grown","grubby","gruesome","grumpy","guilty","gullible","gummy","hairy","half","handmade","handsome","handy","happy","happy-go-lucky","hard","hard-to-find","harmful","harmless","harmonious","harsh","hasty","hateful","haunting","healthy","heartfelt","hearty","heavenly","heavy","hefty","helpful","helpless","hidden","hideous","high","high-level","hilarious","hoarse","hollow","homely","honest","honorable","honored","hopeful","horrible","hospitable","hot","huge","humble","humiliating","humming","humongous","hungry","hurtful","husky","icky","icy","ideal","idealistic","identical","idle","idiotic","idolized","ignorant","ill","illegal","ill-fated","ill-informed","illiterate","illustrious","imaginary","imaginative","immaculate","immaterial","immediate","immense","impassioned","impeccable","impartial","imperfect","imperturbable","impish","impolite","important","impossible","impractical","impressionable","impressive","improbable","impure","inborn","incomparable","incompatible","incomplete","inconsequential","incredible","indelible","inexperienced","indolent","infamous","infantile","infatuated","inferior","infinite","informal","innocent","insecure","insidious","insignificant","insistent","instructive","insubstantial","intelligent","intent","intentional","interesting","internal","international","intrepid","ironclad","irresponsible","irritating","itchy","jaded","jagged","jam-packed","jaunty","jealous","jittery","joint","jolly","jovial","joyful","joyous","jubilant","judicious","juicy","jumbo","junior","jumpy","juvenile","kaleidoscopic","keen","key","kind","kindhearted","kindly","klutzy","knobby","knotty","knowledgeable","knowing","known","kooky","kosher","lame","lanky","large","last","lasting","late","lavish","lawful","lazy","leading","lean","leafy","left","legal","legitimate","light","lighthearted","likable","likely","limited","limp","limping","linear","lined","liquid","little","live","lively","livid","loathsome","lone","lonely","long","long-term","loose","lopsided","lost","loud","lovable","lovely","loving","low","loyal","lucky","lumbering","luminous","lumpy","lustrous","luxurious","mad","made-up","magnificent","majestic","major","male","mammoth","married","marvelous","masculine","massive","mature","meager","mealy","mean","measly","meaty","medical","mediocre","medium","meek","mellow","melodic","memorable","menacing","merry","messy","metallic","mild","milky","mindless","miniature","minor","minty","miserable","miserly","misguided","misty","mixed","modern","modest","moist","monstrous","monthly","monumental","moral","mortified","motherly","motionless","mountainous","muddy","muffled","multicolored","mundane","murky","mushy","musty","muted","mysterious","naive","narrow","nasty","natural","naughty","nautical","near","neat","necessary","needy","negative","neglected","negligible","neighboring","nervous","new","next","nice","nifty","nimble","nippy","nocturnal","noisy","nonstop","normal","notable","noted","noteworthy","novel","noxious","numb","nutritious","nutty","obedient","obese","oblong","oily","oblong","obvious","occasional","odd","oddball","offbeat","offensive","official","old","old-fashioned","only","open","optimal","optimistic","opulent","orange","orderly","organic","ornate","ornery","ordinary","original","other","our","outlying","outgoing","outlandish","outrageous","outstanding","oval","overcooked","overdue","overjoyed","overlooked","palatable","pale","paltry","parallel","parched","partial","passionate","past","pastel","peaceful","peppery","perfect","perfumed","periodic","perky","personal","pertinent","pesky","pessimistic","petty","phony","physical","piercing","pink","pitiful","plain","plaintive","plastic","playful","pleasant","pleased","pleasing","plump","plush","polished","polite","political","pointed","pointless","poised","poor","popular","portly","posh","positive","possible","potable","powerful","powerless","practical","precious","present","prestigious","pretty","precious","previous","pricey","prickly","primary","prime","pristine","private","prize","probable","productive","profitable","profuse","proper","proud","prudent","punctual","pungent","puny","pure","purple","pushy","putrid","puzzled","puzzling","quaint","qualified","quarrelsome","quarterly","queasy","querulous","questionable","quick","quick-witted","quiet","quintessential","quirky","quixotic","quizzical","radiant","ragged","rapid","rare","rash","raw","recent","reckless","rectangular","ready","real","realistic","reasonable","red","reflecting","regal","regular","reliable","relieved","remarkable","remorseful","remote","repentant","required","respectful","responsible","repulsive","revolving","rewarding","rich","rigid","right","ringed","ripe","roasted","robust","rosy","rotating","rotten","rough","round","rowdy","royal","rubbery","rundown","ruddy","rude","runny","rural","rusty","sad","safe","salty","same","sandy","sane","sarcastic","sardonic","satisfied","scaly","scarce","scared","scary","scented","scholarly","scientific","scornful","scratchy","scrawny","second","secondary","second-hand","secret","self-assured","self-reliant","selfish","sentimental","separate","serene","serious","serpentine","several","severe","shabby","shadowy","shady","shallow","shameful","shameless","sharp","shimmering","shiny","shocked","shocking","shoddy","short","short-term","showy","shrill","shy","sick","silent","silky","silly","silver","similar","simple","simplistic","sinful","single","sizzling","skeletal","skinny","sleepy","slight","slim","slimy","slippery","slow","slushy","small","smart","smoggy","smooth","smug","snappy","snarling","sneaky","sniveling","snoopy","sociable","soft","soggy","solid","somber","some","spherical","sophisticated","sore","sorrowful","soulful","soupy","sour","Spanish","sparkling","sparse","specific","spectacular","speedy","spicy","spiffy","spirited","spiteful","splendid","spotless","spotted","spry","square","squeaky","squiggly","stable","staid","stained","stale","standard","starchy","stark","starry","steep","sticky","stiff","stimulating","stingy","stormy","straight","strange","steel","strict","strident","striking","striped","strong","studious","stunning","stupendous","stupid","sturdy","stylish","subdued","submissive","substantial","subtle","suburban","sudden","sugary","sunny","super","superb","superficial","superior","supportive","sure-footed","surprised","suspicious","svelte","sweaty","sweet","sweltering","swift","sympathetic","tall","talkative","tame","tan","tangible","tart","tasty","tattered","taut","tedious","teeming","tempting","tender","tense","tepid","terrible","terrific","testy","thankful","that","these","thick","thin","third","thirsty","this","thorough","thorny","those","thoughtful","threadbare","thrifty","thunderous","tidy","tight","timely","tinted","tiny","tired","torn","total","tough","traumatic","treasured","tremendous","tragic","trained","tremendous","triangular","tricky","trifling","trim","trivial","troubled","true","trusting","trustworthy","trusty","truthful","tubby","turbulent","twin","ugly","ultimate","unacceptable","unaware","uncomfortable","uncommon","unconscious","understated","unequaled","uneven","unfinished","unfit","unfolded","unfortunate","unhappy","unhealthy","uniform","unimportant","unique","united","unkempt","unknown","unlawful","unlined","unlucky","unnatural","unpleasant","unrealistic","unripe","unruly","unselfish","unsightly","unsteady","unsung","untidy","untimely","untried","untrue","unused","unusual","unwelcome","unwieldy","unwilling","unwitting","unwritten","upbeat","upright","upset","urban","usable","used","useful","useless","utilized","utter","vacant","vague","vain","valid","valuable","vapid","variable","vast","velvety","venerated","vengeful","verifiable","vibrant","vicious","victorious","vigilant","vigorous","villainous","violet","violent","virtual","virtuous","visible","vital","vivacious","vivid","voluminous","wan","warlike","warm","warmhearted","warped","wary","wasteful","watchful","waterlogged","watery","wavy","wealthy","weak","weary","webbed","wee","weekly","weepy","weighty","weird","welcome","well-documented","well-groomed","well-informed","well-lit","well-made","well-off","well-to-do","well-worn","wet","which","whimsical","whirlwind","whispered","white","whole","whopping","wicked","wide","wide-eyed","wiggly","wild","willing","wilted","winding","windy","winged","wiry","wise","witty","wobbly","woeful","wonderful","wooden","woozy","wordy","worldly","worn","worried","worrisome","worse","worst","worthless","worthwhile","worthy","wrathful","wretched","writhing","wrong","wry","yawning","yearly","yellow","yellowish","young","youthful","yummy","zany","zealous","zesty","zigzag","rocky"];return this.capFirst(e[this.getRandomInt(0,e.length+1)])}}},1:function(e,t,i){"use strict";class r{constructor(e){this.scene_graph=e,this.store={_cannon:{bodies:[],meshes:[]},_peers:{}}}findByUUID(e,t,i){var r={},a=this;return"string"==typeof e&&(e=[e]),(i||this.scene_graph.container).traverse(function(i){i.userData.plusspace&&e.indexOf(i.userData.plusspace.object.uuid)>-1&&(r[i.userData.plusspace.object.uuid]=t?JSON.stringify(a.scene_graph.serialiseScene(i)):i)}),r}setupNetworking(){var e=this;this.scene_graph.context.socket.on("new-user",function(t){e.store._peers[t.userId]=t}),this.scene_graph.context.socket.on("all-users",function(t){var i=t.filter(function(t){return t.userId===e.scene_graph.context.user.userId});i.length&&t.filter(function(t){return t.userId!==e.scene_graph.context.user.userId&&t.connect_time<i[0].connect_time}).forEach(function(t){e.store._peers[t.userId]=t,e.store._peers[t.userId].peer||e.addPeer({userId:t.userId},!0,e.network_callback||function(){})})}),this.scene_graph.context.socket.emit("all-users"),this.scene_graph.context.socket.on("remove-user",function(t){delete e.store._peers[t.userId]}),this.scene_graph.context.socket.on("signal",function(t){e.store._peers[t.userId]&&e.store._peers[t.userId].peer||(e.store._peers[t.userId]={userId:t.userId},e.addPeer({userId:t.userId},!1,e.network_callback||function(){})),e.store._peers[t.userId].peer.signal(t.signal)})}addPeer(e,t,i){var r=this;if(e.userId!==this.scene_graph.context.user.userId){Object.keys(this.store._peers).filter(function(e){return!!r.store._peers[e]}).length>11&&console.warn("Maximum stream count of 12 achieved. Ignoring further requests.");var a=new SimplePeer({initiator:t,channelName:this.scene_graph.context.space.sid,reconnectTimer:500});a.on("signal",function(t){r.scene_graph.context.socket.emit("signal",{signal:t,userId:e.userId})}),r.store._peers[e.userId].peer=a,a.on("connect",function(){console.log("Shane's Editor: Network peer connection opened - ",e.userId),a.on("close",function(){delete r.store._peers[e.userId]}),a.on("data",function(t){try{i({userId:e.userId,data:new TextDecoder("utf-8").decode(t)})}catch(e){}})}),a.on("error",function(t){console.warn(t),delete r.store._peers[e.userId]})}}getPeers(){return Object.keys(this.store._peers)}sendToAll(e){var t=this;Object.keys(this.store._peers).forEach(function(i){t.store._peers[i].peer&&t.store._peers[i].peer.connected&&t.store._peers[i].peer.connected&&t.store._peers[i].peer.send(e)})}sendTo(e,t){this.store._peers[e]&&this.store._peers[e].peer&&this.store._peers[e].peer.send(t)}onMessage(e){this.network_callback=e}getSceneGraph(){return this.scene_graph}loadJS(e){var t=this;if(this.external_scripts=this.external_scripts||[],this.external_scripts.map(function(e){return e.url+e.loaded}).indexOf(e+"true")>-1)return Promise.resolve();var i=this.external_scripts.map(function(e){return e.url}).indexOf(e);if(i>-1)return new Promise(function(e){t.external_scripts[i].callbacks.push(e)});var r={url:e,loaded:!1,callbacks:[]};return this.external_scripts.push(r),new Promise(function(t){var i=document.createElement("script");i.src=e,i.onload=function(){r.loaded=!0,t(),r.callbacks.forEach(function(e){e()})},i.onreadystatechange=function(){r.loaded=!0,t(),r.callbacks.forEach(function(e){e()})},document.body.appendChild(i)})}portalUser(e){var t=this,i="string"==typeof e;return t.scene_graph.context.user&&!this.not_to_move?(this.not_to_move=!0,this.plusspaceTargetEntity||(this.plusspaceTargetEntity=new THREE.Object3D,this.scene_graph.context.simulation.scene.add(this.plusspaceTargetEntity),this.plusspaceTargetTrigger=new THREE.Object3D,this.scene_graph.context.simulation.scene.add(this.plusspaceTargetTrigger),this.plusspacePortal=new altspaceutil.behaviors.NativeComponent("n-portal",i?{targetSpace:e}:{},i?{}:{targetEntity:this.plusspaceTargetEntity}),this.plusspaceAttach=new altspaceutil.behaviors.NativeComponent("n-skeleton-parent",{index:0,part:"eye",side:"left",userId:t.scene_graph.context.user.userId}),this.plusspaceTargetTrigger.addBehaviors(this.plusspacePortal,this.plusspaceAttach),this.plusspaceTargetTrigger.scale.set(1e-5,1,1e-5),this.plusspaceTargetTrigger.position.set(0,-1e3,0)),i||(this.plusspaceTargetEntity.position.set(e.x,e.y,e.z),this.plusspacePortal.data.targetPosition=this.plusspaceTargetEntity.position),this.plusspaceTargetTrigger.position.set(0,0,0),new Promise(function(e){setTimeout(function(){t.plusspaceTargetTrigger.position.set(0,-1e3,0),t.not_to_move=!1,e()},2e3)})):Promise.reject("not_to_move")}getCannonWorld(){return this.cannonWorld||(this.cannonWorld=new CANNON.World),this.cannonWorld}getPortalSocket(){return this.scene_graph.context.portal_socket}bakeLight(e){return this.scene_graph.lighting.bakeVertexLighting(e,this.scene_graph.light)}resetCannonWorld(e){if(this.cannonWorld)for(var t=this.store._cannon.meshes.length,i=0;i<t;i++){this.cannonWorld.remove(this.store._cannon.bodies.pop());var r=this.store._cannon.meshes.pop();e.remove(r)}}addCannonMesh(e,t,i,r){this.cannonBodyAxisSwap(e);var a=new THREE.Object3D;i.add(a);for(var s=new THREE.MeshBasicMaterial(r?{visible:!1}:{side:THREE.DoubleSide,color:t,map:(new THREE.TextureLoader).load("/images/display_texture.png")}),n=0;n<e.shapes.length;n++){var o,l=e.shapes[n];switch(l.type){case CANNON.Shape.types.SPHERE:var c=new THREE.SphereGeometry(l.radius,16,16);o=new THREE.Mesh(c,s);break;case CANNON.Shape.types.PARTICLE:o=new THREE.Mesh(this.particleGeo,particleMaterial);var h=this.settings;o.scale.set(h.particleSize,h.particleSize,h.particleSize);break;case CANNON.Shape.types.PLANE:var u=new THREE.PlaneGeometry(10,10,4,4);o=new THREE.Object3D;var d=new THREE.Object3D,p=new THREE.Mesh(u,s);p.scale.set(100,100,100),d.add(p),o.add(d);break;case CANNON.Shape.types.BOX:var m=new THREE.BoxGeometry(2*l.halfExtents.x,2*l.halfExtents.y,2*l.halfExtents.z);o=new THREE.Mesh(m,s);break;case CANNON.Shape.types.CONVEXPOLYHEDRON:for(var g=new THREE.Geometry,y=0;y<l.vertices.length;y++){var f=l.vertices[y];g.vertices.push(new THREE.Vector3(f.x,f.y,f.z))}for(y=0;y<l.faces.length;y++)for(var b=l.faces[y],v=b[0],w=1;w<b.length-1;w++){var E=b[w],M=b[w+1];g.faces.push(new THREE.Face3(v,E,M))}g.computeBoundingSphere(),g.computeVertexNormals(),g.computeFaceNormals(),o=new THREE.Mesh(g,s);break;case CANNON.Shape.types.HEIGHTFIELD:u=new THREE.Geometry;for(var x=new CANNON.Vec3,k=new CANNON.Vec3,T=new CANNON.Vec3,S=0;S<l.data.length-1;S++)for(var G=0;G<l.data[S].length-1;G++)for(var P=0;P<2;P++){l.getConvexTrianglePillar(S,G,0===P),x.copy(l.pillarConvex.vertices[0]),k.copy(l.pillarConvex.vertices[1]),T.copy(l.pillarConvex.vertices[2]),x.vadd(l.pillarOffset,x),k.vadd(l.pillarOffset,k),T.vadd(l.pillarOffset,T),u.vertices.push(new THREE.Vector3(x.x,x.y,x.z),new THREE.Vector3(k.x,k.y,k.z),new THREE.Vector3(T.x,T.y,T.z));y=u.vertices.length-3;u.faces.push(new THREE.Face3(y,y+1,y+2))}u.computeBoundingSphere(),u.computeFaceNormals(),u.computeVertexNormals(),o=new THREE.Mesh(u,s);break;case CANNON.Shape.types.TRIMESH:for(u=new THREE.Geometry,x=new CANNON.Vec3,k=new CANNON.Vec3,T=new CANNON.Vec3,y=0;y<l.indices.length/3;y++){l.getTriangleVertices(y,x,k,T),u.vertices.push(new THREE.Vector3(x.x,x.y,x.z),new THREE.Vector3(k.x,k.y,k.z),new THREE.Vector3(T.x,T.y,T.z));w=u.vertices.length-3;u.faces.push(new THREE.Face3(w,w+1,w+2))}u.computeBoundingSphere(),u.computeFaceNormals(),u.computeVertexNormals(),o=new THREE.Mesh(u,s);break;default:throw"Visual type not recognized: "+l.type}var R=e.shapeOffsets[n],_=e.shapeOrientations[n];o.position.set(R.x,R.y,R.z),o.quaternion.set(_.x,_.y,_.z,_.w),a.add(o)}return this.store._cannon.bodies.push(e),this.store._cannon.meshes.push(a),a}cannonBodyAxisSwap(e){}updateCannonPhysics(){if(this.cannonWorld){var e=Date.now()/1e3;if(!this.lastCallTime)return this.cannonWorld.step(1/90),void(this.lastCallTime=e);var t=e-this.lastCallTime;this.cannonWorld.step(1/90,t,3),this.lastCallTime=e}for(var i=this.store._cannon.bodies.length,r=0;r<i;r++){var a=this.store._cannon.bodies[r],s=this.store._cannon.meshes[r];s.position.copy(a.position),a.quaternion&&s.quaternion.copy(a.quaternion)}}}class a{constructor(e){this.sceneGraph=e}makeMaterial(e){let t={};return new Promise(i=>{if(Object.keys(e).filter(function(e){return-1===["type","map","texture","lightTexture","normalMap","lightMap","envMap","alphaMap","aoMap","emissiveMap","metalnessMap","normalMap","roughnessMap","bumpMap"].indexOf(e)}).forEach(function(i){t[i]=e[i]}),e.map&&"string"==typeof e.map)try{let r=(new THREE.TextureLoader).load(e.map,()=>{i(new THREE[e.type](t))});r.offset.set(e.texture.offset.x||0,e.texture.offset.y||0),r.repeat.set(e.texture.repeat.x||1,e.texture.repeat.y||1),e.texture.wrapping&&(r.wrapS=e.texture.wrapping.s,r.wrapT=e.texture.wrapping.t,r.minFilter=e.texture.filters.min,r.magFilter=e.texture.filters.mag),t.map=r}catch(e){console.log(e)}else i(new THREE[e.type](t))})}phongSettingsWithDefaults(e,t){["MeshPhongMaterial","MeshToonMaterial"].indexOf(t.type)>-1&&(e.color=t.color||"#ffffff",e.bumpMap=t.bumpMap||"",e.bumpScale=t.bumpScale||1,e.displacementMap=t.displacementMap||"",e.displacementScale=t.displacementScale||1,e.displacementBias=t.displacementBias||0,e.emissive=t.emissive||"#000",e.emissiveMap=t.emissiveMap||"",e.emissiveIntensity=t.emissiveIntensity||1,e.morphNormals=t.morphNormals||!1,e.morphTargets=t.morphTargets||!1,e.normalMap=t.normalMap||"",e.normalScale=t.normalScale||new THREE.Vector2(1,1),e.shininess=t.shininess||30,e.specular=t.specular||"#111111",e.specularMap=t.specularMap||"",e.reflectivity=t.reflectivity||.5,e.refractionRatio=t.reflectivity||.98,e.skinning=t.skinning||!1)}standardSettingsWithDefaults(e,t){["MeshStandardMaterial","MeshPhysicalMaterial"].indexOf(t.type)>-1&&(e.color=t.color||"#ffffff",e.bumpMap=t.bumpMap||"",e.bumpScale=t.bumpScale||1,e.displacementMap=t.displacementMap||"",e.displacementScale=t.displacementScale||1,e.displacementBias=t.displacementBias||0,e.emissive=t.emissive||"#000000",e.emissiveMap=t.emissiveMap||"",e.emissiveIntensity=t.emissiveIntensity||1,e.envMapIntensity=t.emissiveIntensity||1,e.metalness=t.metalness||.5,e.metalnessMap=t.metalnessMap||"",e.morphNormals=t.morphNormals||!1,e.morphTargets=t.morphTargets||!1,e.normalMap=t.normalMap||"",e.normalScale=t.normalScale||new THREE.Vector2(1,1),e.roughness=t.roughness||.8,e.roughnessMap=t.roughnessMap||"",e.refractionRatio=t.reflectivity||.98,e.skinning=t.skinning||!1)}wireframeSettingsWithDefaults(e,t){["MeshBasicMaterial","MeshStandardMaterial","MeshLambertMaterial","MeshPhongMaterial","MeshPhysicalMaterial","MeshToonMaterial"].indexOf(t.type)>-1&&(e.wireframe=t.wireframe||!1,e.wireframeLinecap=t.wireframeLinecap||"round",e.wireframeLinejoin=t.wireframeLinejoin||"round",e.wireframeLinewidth=t.wireframeLinewidth||1)}mapSettingsWithDefaults(e,t){["MeshBasicMaterial","MeshStandardMaterial","MeshLambertMaterial","MeshPhongMaterial","MeshPhysicalMaterial","MeshToonMaterial"].indexOf(t.type)>-1&&(e.map=t.map||"",e.alphaMap=t.alphaMap||"",e.aoMap=t.aoMap||"",e.aoMapIntensity=t.aoMapIntensity||1,e.envMap=t.envMap||"",e.lightMap=t.lightMap||"",e.lightMapIntensity=t.lightMapIntensity||1)}materialSettingsWithDefaults(e){let t={type:e.type||"MeshStandardMaterial",visible:!1!==e.visible||e.visible,transparent:e.transparent||!1,alphaTest:e.alphaTest||.5,opacity:e.opacity||1,side:e.side||THREE.FrontSide,texture:{wrapping:{s:e.texture&&e.texture.wrapping?e.texture.wrapping.s:THREE.RepeatWrapping,t:e.texture&&e.texture.wrapping?e.texture.wrapping.t:THREE.RepeatWrapping},repeat:{x:e.texture&&e.texture.repeat?e.texture.repeat.x:1,y:e.texture&&e.texture.repeat?e.texture.repeat.y:1},offset:{x:e.texture&&e.texture.offset?e.texture.offset.x:0,y:e.texture&&e.texture.offset?e.texture.offset.y:0},filters:{mag:e.texture&&e.texture.filters?e.texture.filters.mag:THREE.LinearFilter,min:e.texture&&e.texture.filters?e.texture.filters.min:THREE.LinearMipMapLinearFilter}},lightTexture:{wrapping:{s:e.lightTexture&&e.lightTexture.wrapping?e.lightTexture.wrapping.s:THREE.RepeatWrapping,t:e.lightTexture&&e.lightTexture.wrapping?e.lightTexture.wrapping.t:THREE.RepeatWrapping},repeat:{x:e.lightTexture&&e.lightTexture.repeat?e.lightTexture.repeat.x:0,y:e.lightTexture&&e.lightTexture.repeat?e.lightTexture.repeat.y:0},offset:{x:e.lightTexture&&e.lightTexture.offset?e.lightTexture.offset.x:0,y:e.lightTexture&&e.lightTexture.offset?e.lightTexture.offset.y:0},filters:{mag:e.lightTexture&&e.lightTexture.filters?e.lightTexture.filters.mag:THREE.LinearFilter,min:e.lightTexture&&e.lightTexture.filters?e.lightTexture.filters.min:THREE.LinearMipMapLinearFilter}}};switch(e.type){case"MeshBasicMaterial":this.mapSettingsWithDefaults(t,e),t.color=e.color||"#ffffff",t.reflectivity=e.reflectivity||.5,t.refractionRatio=e.reflectivity||.98,t.skinning=e.skinning||!1,t.lights=e.lights||!1,t.fog=e.fog||!1,t.specularMap=e.specularMap||"",this.wireframeSettingsWithDefaults(t,e);break;case"MeshStandardMaterial":this.mapSettingsWithDefaults(t,e),this.standardSettingsWithDefaults(t,e),this.wireframeSettingsWithDefaults(t,e);break;case"MeshLambertMaterial":this.mapSettingsWithDefaults(t,e),t.color=e.color||"#ffffff",t.emissive=e.emissive||"#000",t.emissiveMap=e.emissiveMap||"",t.emissiveIntensity=e.emissiveIntensity||1,t.morphNormals=e.morphNormals||!1,t.morphTargets=e.morphTargets||!1,t.reflectivity=e.reflectivity||.5,t.refractionRatio=e.reflectivity||.98,t.skinning=e.skinning||!1,t.specularMap=e.specularMap||"",this.wireframeSettingsWithDefaults(t,e);break;case"MeshPhongMaterial":this.mapSettingsWithDefaults(t,e),this.phongSettingsWithDefaults(t,e),this.wireframeSettingsWithDefaults(t,e);break;case"MeshDepthMaterial":t.alphaMap=e.alphaMap||"",t.fog=e.fog||!1,t.lights=e.lights||!1,t.displacementMap=e.displacementMap||"",t.displacementScale=e.displacementScale||1,t.displacementBias=e.displacementBias||0,t.depthPacking=e.depthPacking||THREE.BasicDepthPacking,t.map=e.map||"",t.skinning=e.skinning||!1,t.wireframe=e.wireframe||!1,t.wireframeLinewidth=e.wireframeLinewidth||1;break;case"MeshPhysicalMaterial":this.mapSettingsWithDefaults(t,e),this.standardSettingsWithDefaults(t,e),t.clearCoat=e.clearCoat||0,t.clearCoatRoughness=e.clearCoatRoughness||0,t.reflectivity=e.reflectivity||.5,this.wireframeSettingsWithDefaults(t,e);break;case"MeshToonMaterial":this.mapSettingsWithDefaults(t,e),t.gradientMap=e.gradientMap||"",this.phongSettingsWithDefaults(t,e),this.wireframeSettingsWithDefaults(t,e)}return t}}class s{klein(e,t){let i,r,a;return t*=Math.PI,e*=2*Math.PI,(t*=2)<Math.PI?(i=3*Math.cos(t)*(1+Math.sin(t))+2*(1-Math.cos(t)/2)*Math.cos(t)*Math.cos(e),a=-8*Math.sin(t)-2*(1-Math.cos(t)/2)*Math.sin(t)*Math.cos(e)):(i=3*Math.cos(t)*(1+Math.sin(t))+2*(1-Math.cos(t)/2)*Math.cos(e+Math.PI),a=-8*Math.sin(t)),r=-2*(1-Math.cos(t)/2)*Math.sin(e),new THREE.Vector3(i,r,a)}invertedKlein(e,t){return this.klein(t,e)}mobius(e,t){let i,r,a;e-=.5,t=2*Math.PI*t;return i=Math.cos(t)*(2+e*Math.cos(t/2)),r=Math.sin(t)*(2+e*Math.cos(t/2)),a=e*Math.sin(t/2),new THREE.Vector3(i,r,a)}mobius3d(e,t){e*=Math.PI,t*=2*Math.PI;let i,r,a,s=(e*=2)/2;return i=.125*Math.cos(t)*Math.cos(s)-.65*Math.sin(t)*Math.sin(s),a=.125*Math.cos(t)*Math.sin(s)+.65*Math.sin(t)*Math.cos(s),r=(2.25+i)*Math.sin(e),i=(2.25+i)*Math.cos(e),new THREE.Vector3(i,r,a)}invertedMobius3d(e,t){return this.mobius3d(t,e)}apple(e,t){e=2*e*Math.PI,t=2*t*Math.PI-Math.PI;let i=Math.cos(e)*(4+3.8*Math.cos(t)),r=Math.sin(e)*(4+3.8*Math.cos(t)),a=(Math.cos(t)+Math.sin(t)-1)*(1+Math.sin(t))*Math.log(1-Math.PI*t/10)+7.5*Math.sin(t);return new THREE.Vector3(i,r,a)}invertedApple(e,t){return this.apple(t,e)}snail(e,t){e=2*e*Math.PI,t=4*t*Math.PI-2*Math.PI;let i=e*Math.cos(t)*Math.sin(e),r=e*Math.cos(e)*Math.cos(t),a=-e*Math.sin(t);return new THREE.Vector3(i,r,a)}invertedSnail(e,t){return this.snail(t,e)}spiral(e,t){e=2*e*-Math.PI;let i=.1*(1-(t=2*t*-Math.PI)/2*Math.PI)*Math.cos(4*t)*(1-Math.cos(e))+.3*Math.cos(4*t),r=.1*(1-t/2*Math.PI)*Math.sin(4*t)*(1-Math.cos(e))+.3*Math.sin(4*t),a=1*t/2*Math.PI+.1*(1-t/2*Math.PI)*Math.sin(e);return new THREE.Vector3(i,r,a)}invertedSpiral(e,t){return this.spiral(t,e)}fermet(e,t){e=16*e-8,abs_u=e<0?-e:e,t*=1;let i=e<0?-1:1,r=i*Math.sqrt(abs_u)*Math.cos(abs_u),a=.8*t,s=i*Math.sqrt(abs_u)*Math.sin(abs_u);return new THREE.Vector3(r,s,a)}helicoid(e,t){e=6*e*-Math.PI;let i=2*(t=2*t*Math.PI-Math.PI)*Math.cos(e),r=2*t*Math.sin(e),a=e;return new THREE.Vector3(i,r,a)}horn(e,t){t=2*t*Math.PI;let i=(2+e*Math.cos(t))*Math.cos(2*Math.PI*e)+2*e,r=(2+e*Math.cos(t))*Math.sin(2*Math.PI*e),a=e*Math.sin(t);return new THREE.Vector3(i,r,a)}invertedHorn(e,t){return this.horn(t,e)}pillow(e,t){e=2*e*Math.PI-Math.PI,t=2*t*Math.PI-Math.PI;let i=Math.cos(e),r=Math.cos(t),a=Math.sin(e)*Math.sin(t);return new THREE.Vector3(i,r,a)}invertedPillow(e,t){return this.pillow(t,e)}spring(e,t){e=6*e*-Math.PI,t=2*t*Math.PI-Math.PI;let i=(1-.3*Math.cos(t))*Math.cos(e),r=(1-.3*Math.cos(t))*Math.sin(e),a=.3*(Math.sin(t)+1.2*e/Math.PI);return new THREE.Vector3(i,r,a)}invertedSpring(e,t){return this.spring(t,e)}scherk(e,t){let i=t=t*Math.PI-Math.PI/2,r=e=e*Math.PI-Math.PI/2,a=Math.log(Math.cos(.9*e)/Math.cos(.9*t))/.9;return new THREE.Vector3(i,r,a)}catenoid(e,t){e=2*e*Math.PI,t=2*t*Math.PI-Math.PI;let i=2*Math.cosh(t/2)*Math.sin(e),r=2*Math.cosh(t/2)*Math.cos(e),a=t;return new THREE.Vector3(i,r,a)}natica(e,t){e=21*e-20,t*=2*Math.PI;let i=Math.exp(.18*e),r=Math.sin(t),a=Math.cos(t),s=Math.sin(1*e),n=i*(1.25+2.6*a)*Math.cos(1*e),o=1*i*(1.25+2.6*a)*s,l=i*(2.4*r-2.8);return new THREE.Vector3(n,o,l)}invertedNatica(e,t){return this.natica(t,e)}}class n{constructor(e){this.sceneGraph=e,this.parametricGeometries=new s}makeGeometry(e){let t=this.geometrySettingsWithDefaults(e),i=[null];for(let e in t)t.hasOwnProperty(e)&&i.push(t[e]);return new(Function.prototype.bind.apply(THREE[e.type],i))}makeParametric(e){let t=this.parametricSettingsWithDefaults(e),i={document:document,scene:this.sceneGraph.context.sceneEl.object3D,root:this.sceneGraph.container,helper:this.sceneGraph.behaviourHelper},r=t.user_options||{},a=[null,{AppleGeometry:this.parametricGeometries.apple,AppleInvertedGeometry:this.parametricGeometries.invertedApple.bind(this.parametricGeometries),FermatGeometry:this.parametricGeometries.fermet,KleinGeometry:this.parametricGeometries.klein,KleinInvertedGeometry:this.parametricGeometries.invertedKlein.bind(this.parametricGeometries),HelicoidGeometry:this.parametricGeometries.helicoid,PillowGeometry:this.parametricGeometries.pillow,PillowInvertedGeometry:this.parametricGeometries.invertedPillow.bind(this.parametricGeometries),ScherkGeometry:this.parametricGeometries.scherk,MobiusGeometry:this.parametricGeometries.mobius,Mobius3DGeometry:this.parametricGeometries.mobius3d,Mobius3DInvertedGeometry:this.parametricGeometries.invertedMobius3d.bind(this.parametricGeometries),NaticaStellataGeometry:this.parametricGeometries.natica,NaticaInvertedGeometry:this.parametricGeometries.invertedNatica.bind(this.parametricGeometries),HornGeometry:this.parametricGeometries.horn,HornInvertedGeometry:this.parametricGeometries.invertedHorn.bind(this.parametricGeometries),SpringGeometry:this.parametricGeometries.spring,SpringInvertedGeometry:this.parametricGeometries.invertedSpring.bind(this.parametricGeometries),CatenoidGeometry:this.parametricGeometries.catenoid,SnailGeometry:this.parametricGeometries.snail,SnailInvertedGeometry:this.parametricGeometries.invertedSnail.bind(this.parametricGeometries),SpiralGeometry:this.parametricGeometries.spiral,SpiralInvertedGeometry:this.parametricGeometries.invertedSpiral.bind(this.parametricGeometries),CustomGeometry:function(e,a){let s=new THREE.Vector3(1,1,1);try{(s=new Function("u","v","globals","user_config",t.method||"return new THREE.Vector3(0,0,0);")(e,a,i,r))&&s.constructor===THREE.Vector3||(console.warn("Custom Geometry Error: ",t.name,"Definition does not return a THREE.Vector3"),s=new THREE.Vector3(1,1,1))}catch(e){console.warn("Custom Geometry Error: ",t.name,e),s=new THREE.Vector3(1,1,1)}return s}}[e.sub_type]],s=["name","description","method","image","user_config","user_options","parametric_id"];for(let e in t)t.hasOwnProperty(e)&&-1===s.indexOf(e)&&a.push(t[e]);return new(Function.prototype.bind.apply(THREE.ParametricBufferGeometry,a))}parametricSettingsWithDefaults(e){switch(e.sub_type){case"AppleGeometry":case"AppleInvertedGeometry":case"FermatGeometry":case"SpringGeometry":case"SpringInvertedGeometry":case"NaticaStellataGeometry":case"NaticaStellataInvertedGeometry":case"HelicoidGeometry":case"SpiralGeometry":case"SpiralInvertedGeometry":case"PillowGeometry":case"PillowInvertedGeometry":case"CatenoidGeometry":case"ScherkGeometry":case"KleinGeometry":case"KleinInvertedGeometry":case"MobiusGeometry":case"Mobius3DGeometry":case"Mobius3DInvertedGeometry":case"SnailGeometry":case"SnailInvertedGeometry":case"HornGeometry":case"HornInvertedGeometry":return{slices:e.slices||24,stacks:e.stacks||24};case"CustomGeometry":return{name:e.name||"",description:e.description||"",image:e.image||"images/parametric.png",method:e.method||"",user_config:e.user_config||"",user_options:e.user_options||{},parametric_id:e.parametric_id||0,slices:e.slices||24,stacks:e.stacks||24}}}geometrySettingsWithDefaults(e){switch(e.type){case"BoxGeometry":case"BoxBufferGeometry":return{width:e.width||1,height:e.height||1,depth:e.depth||1,widthSegments:e.widthSegments||1,heightSegments:e.heightSegments||1,depthSegments:e.depthSegments||1};case"CircleGeometry":case"CircleBufferGeometry":return{radius:e.radius||1,segments:e.segments||24,thetaStart:e.thetaStart||0,thetaLength:e.thetaLength||2*Math.PI};case"ConeGeometry":case"ConeBufferGeometry":return{radius:e.radius||1,height:e.height||1,radialSegments:e.radialSegments||24,heightSegments:e.heightSegments||1,openEnded:!1,thetaStart:e.thetaStart||0,thetaLength:e.thetaLength||2*Math.PI};case"CylinderGeometry":case"CylinderBufferGeometry":return{radiusTop:e.radiusTop||1,radiusBottom:e.radiusBottom||1,height:e.height||1,radialSegments:e.radialSegments||24,heightSegments:e.heightSegments||1,openEnded:!1,thetaStart:e.thetaStart||0,thetaLength:e.thetaLength||2*Math.PI};case"DodecahedronGeometry":case"DodecahedronBufferGeometry":return{radius:e.radius||1,detail:e.detail||1};case"IcosahedronGeometry":case"IcosahedronBufferGeometry":return{radius:e.radius||1,detail:e.detail||1};case"OctahedronGeometry":case"OctahedronBufferGeometry":return{radius:e.radius||1,detail:e.detail||1};case"PlaneGeometry":case"PlaneBufferGeometry":return{width:e.width||1,height:e.height||1,widthSegments:e.widthSegments||1,heightSegments:e.heightSegments||1};case"RingGeometry":case"RingBufferGeometry":return{innerRadius:e.innerRadius||.5,outerRadius:e.outerRadius||1,thetaSegments:e.thetaSegments||24,phiSegments:e.phiSegments||8,thetaStart:e.thetaStart||0,thetaLength:e.thetaLength||2*Math.PI};case"SphereGeometry":case"SphereBufferGeometry":return{radius:e.radius||1,widthSegments:e.widthSegments||16,heightSegments:e.heightSegments||16,phiStart:e.phiStart||0,phiLength:e.phiLength||2*Math.PI,thetaStart:e.thetaStart||0,thetaLength:e.thetaLength||Math.PI};case"TetrahedronGeometry":case"TetrahedronBufferGeometry":return{radius:e.radius||1,detail:e.detail||0};case"TorusGeometry":case"TorusBufferGeometry":return{radius:e.radius||1,tube:e.tube||.4,radialSegments:e.radialSegments||8,tubularSegments:e.tubularSegments||16,arc:e.arc||2*Math.PI};case"TorusKnotGeometry":case"TorusKnotBufferGeometry":return{radius:e.radius||1,tube:e.tube||.4,tubularSegments:e.tubularSegments||64,radialSegments:e.radialSegments||8,p:e.p||2,q:e.q||3};default:return{}}}}class o{constructor(e){this.sceneGraph=e,this.materialFactory=new a(e),this.geometryFactory=new n(e)}changeGeometry(e){let t="Primitive"===this.sceneGraph.context.currentObject.settings.type,i=this.geometryFactory[t?"geometrySettingsWithDefaults":"parametricSettingsWithDefaults"](t?{type:e}:{sub_type:e});this.sceneGraph.context.currentObject.settings.geometry=i,t?this.sceneGraph.context.currentObject.settings.geometry.type=e:this.sceneGraph.context.currentObject.settings.geometry.sub_type=e,this.resetGeometry()}resetGeometry(){let e=this.sceneGraph.context.currentObject.settings;this.sceneGraph.context.currentObject.object3D.geometry="Primitive"===e.type?this.geometryFactory.makeGeometry(e.geometry):this.geometryFactory.makeParametric(e.geometry),"Primitive"!==e.type&&this.scaleAndCenterGeometry(this.sceneGraph.context.currentObject.object3D.geometry),this.addStats(this.sceneGraph.context.currentObject.object3D,this.sceneGraph.context.currentObject)}changeMaterial(e){let t=this.sceneGraph.context.currentObject.settings;t.material.type=e,this.sceneGraph.context.currentObject.settings.material=this.materialFactory.materialSettingsWithDefaults(t.material),this.materialFactory.makeMaterial(this.sceneGraph.context.currentObject.settings.material).then(e=>{this.sceneGraph.context.currentObject.object3D.material=e})}generateUserData(e){let t=this.defaultUserData(e.type,e.sub_type||"",e.geo_settings||{},e.mat_settings||{},e.tra_settings||{},e.name);return e.url&&(t.url=e.url),e.mtl_url&&(t.mtl_url=e.mtl_url,t.mtl_path=e.mtl_path),t.state.added=!0,t}defaultUserData(e,t,i,r,a,s,n){return(i=i||{}).type=t,i.sub_type=i.sub_type||"",{name:s||this.sceneGraph.context.namer.generateName(),uuid:n||THREE.Math.generateUUID(),type:e||"Object3D",transform:{position:{x:a&&a.position&&a.position.x||0,y:a&&a.position&&a.position.y||0,z:a&&a.position&&a.position.z||0},rotation:{x:a&&a.rotation&&a.rotation.x||0,y:a&&a.rotation&&a.rotation.y||0,z:a&&a.rotation&&a.rotation.z||0},scale:{x:a&&a.scale&&a.scale.x||1,y:a&&a.scale&&a.scale.y||1,z:a&&a.scale&&a.scale.z||1}},behaviours:[],hide_on_mobile:!1,hide_on_desktop:!1,preserve_scale:!1,geometry:i||{},material:this.materialFactory.materialSettingsWithDefaults(r||{}),state:{added:!1,updated:!1,transform_update:!1,removed:!1}}}getTotals(e){let t={points:0,pixels:0},i=[];return e.traverse(e=>{e.geometry&&e.geometry.attributes?t.points+=e.geometry.attributes.position.count:e.geometry&&e.geometry.faces&&(t.points+=3*e.geometry.faces.length),e.material&&e.material.map&&e.material.map.image&&-1===i.indexOf(e.material.map.image.currentSrc)&&(i.push(e.material.map.image.currentSrc),t.pixels+=e.material.map.image.width*e.material.map.image.height)}),t}addStats(e,t){t.settings.stats||(t.settings.stats=this.getTotals(e))}transform(e,t){e.userData.sceneObject=t,e&&(e.rotation.set(t.settings.transform.rotation.x,t.settings.transform.rotation.y,t.settings.transform.rotation.z),e.position.set(t.settings.transform.position.x,t.settings.transform.position.y,t.settings.transform.position.z),e.scale.set(t.settings.transform.scale.x,t.settings.transform.scale.y,t.settings.transform.scale.z))}resolveObject(e,t,i,r){this.transform(e,i),this.scaleAndCenterObject(t),e.add(t),this.addStats(e,i),setTimeout(()=>r(e),50)}make(e){let t=e.settings;return new Promise(i=>{let r,a,s,n;switch(t.type){case"Primitive":a=this.geometryFactory.makeGeometry(t.geometry),this.materialFactory.makeMaterial(t.material).then(t=>{r=new THREE.Mesh(a,t),this.transform(r,e),this.addStats(r,e),i(r)});break;case"Parametric":a=this.geometryFactory.makeParametric(t.geometry),this.scaleAndCenterGeometry(a),this.materialFactory.makeMaterial(t.material).then(t=>{r=new THREE.Mesh(a,t),this.transform(r,e),this.addStats(r,e),i(r)});break;case"Object3D":(r=new THREE.Object3D).name="Group",this.transform(r,e),r.userData.sceneObject.stats={points:0,pixels:0},i(r);break;case"Poly":case"Custom":switch((r=new THREE.Object3D).name=t.type,t.geometry.type){case"GLTF2":(s=Promise.resolve(t.url)).then(t=>{let a=new THREE.GLTFLoader;a.setCrossOrigin(!0),a.load(t,t=>this.resolveObject(r,t.scene,e,i))});break;case"DAE":let a=t.url;(n=new THREE.ColladaLoader).setCrossOrigin(!0),n.load(a,t=>this.resolveObject(r,t.scene,e,i));break;case"GLTF":(n=new THREE.LegacyGLTFLoader).setCrossOrigin(!0),n.load(t.url,t=>this.resolveObject(r,t.scene,e,i));break;case"OBJ":s=Promise.resolve({obj:t.url,mtl:t.mtl_url,mtl_path:t.mtl_path}),"Poly"===t.type&&(s=Promise.all([new Promise(function(e){(new THREE.FileLoader).load("poly-proxy/"+encodeURIComponent(t.url),function(t){e(t)})}),new Promise(function(e){(new THREE.FileLoader).load("poly-proxy/"+encodeURIComponent(t.mtl_url),function(t){e(t)})})]).then(function(e){let i=t.url.replace(t.mtl_path,"");return{obj:e[0],mtl:e[1],mtl_path:e[0].slice(0,e[0].indexOf(i))}})),(n=new THREE.MTLLoader).setCrossOrigin(!0),s.then(t=>{n.setTexturePath(t.mtl_path),n.load(t.mtl,a=>{a.preload(),(n=new THREE.OBJLoader).setMaterials(a),n.load(t.obj,t=>this.resolveObject(r,t,e,i))})})}}})}getScaledVector(e){return e.x>=e.y&&e.x>=e.z?new THREE.Vector3(1,e.y/e.x,e.z/e.x):e.y>e.x&&e.y>e.z?new THREE.Vector3(e.x/e.y,1,e.z/e.y):e.z>e.x&&e.z>e.y?new THREE.Vector3(e.x/e.z,e.y/e.z,1):new THREE.Vector3(1,1,1)}scaleAndCenterGeometry(e){e.computeBoundingBox();let t=e.boundingBox.getSize(),i=this.getScaledVector(t),r=t.divide(i);e.scale(1/r.x,1/r.y,1/r.z),e.center()}scaleAndCenterObject(e){let t=(new THREE.Box3).setFromObject(e),i=t.getSize(),r=this.getScaledVector(i),a=i.divide(r);e.scale.set(1/a.x,1/a.y,1/a.z);let s=t.getCenter().clone().negate();e.position.copy(new THREE.Vector3(s.x/a.x,s.y/a.y,s.z/a.z))}}class l{constructor(e){this.sceneGraph=e}deSerialiseScene(e,t,i){if(e&&e.settings){t=t||this.sceneGraph.container,i=i||[],e.settings.uuid||(e.settings.uuid=THREE.Math.generateUUID()),e.object3D=t,t.userData.sceneObject=e;for(let r=0;r<e.children.length;r++)i.push(Promise.resolve().then(()=>{let a=e.children[r];if(a)return this.sceneGraph.objectFactory.make(a).then(r=>{if(r)return t.add(r),r.userData.sceneObject=a,a.object3D=r,a.parent=e,this.deSerialiseScene(a,r,i),{object:r,child:a}})}));return i}}serialiseScene(e){if(e=e||this.sceneGraph.container,!this.isObject(e))return;let t={settings:{},children:[]};return e.userData=e.userData||{},e.userData.plusspace=e.userData.plusspace||this.sceneGraph.objectFactory.defaultUserData(),t.settings=e.userData.plusspace,"Custom"!==t.settings.type&&"Poly"!==t.settings.type&&e.children&&e.children.length&&e.children.forEach(e=>{t.children.push(this.serialiseScene(e))}),t}isObject(e){return e.userData&&e.userData.plusspace&&e.userData.plusspace.object&&e.userData.plusspace.geometry&&e.userData.plusspace.material}}class c{constructor(e){this.scene_graph=e}resetBehaviours(e){let t=this;e.removeAllBehaviors();let i=[];e.userData.plusspace.altspace.behaviours.forEach(function(r,a){let s=r.settings||{};s.trigger=s.trigger||"auto-trigger",s.trigger&&["toggle-trigger","mod-toggle-trigger","no-mod-toggle-trigger","click-trigger","mod-click-trigger","no-mod-click-trigger"].indexOf(s.trigger)>-1&&e.userData.altspace&&(e.userData.altspace.collider=e.userData.altspace.collider||{},e.userData.altspace.collider.enabled=!0);let n=t.getBehaviour(r,e),o=function(){(e=t.resetObject(e)).addBehavior(n),s.sync&&t.context.socket.emit("behaviour-sync",{index:a,uuid:e.userData.plusspace.object.uuid})},l=function(){e.userData.has_been_clicked?((e=t.resetObject(e)).userData.has_been_clicked=!1,t.context.socket.emit("behaviour-sync",{index:a,uuid:e.userData.plusspace.object.uuid,is_toggle:!0,enabled:!1})):(e.userData.has_been_clicked=!0,e.addBehavior(n),console.log(n),s.sync&&t.context.socket.emit("behaviour-sync",{index:a,uuid:e.userData.plusspace.object.uuid,is_toggle:!0,enabled:!0}))};if(n)switch(s.trigger){case"auto-trigger":i.push(n);break;case"mod-auto-trigger":t.context.user&&t.context.user.isModerator&&e.addBehavior(n);break;case"no-mod-auto-trigger":t.context.user&&!t.context.user.isModerator&&e.addBehavior(n);break;case"click-trigger":e.addEventListener("cursordown",function(){o()});break;case"mod-click-trigger":e.addEventListener("cursordown",function(){t.context.user&&t.context.user.isModerator&&o()});break;case"no-mod-click-trigger":e.addEventListener("cursordown",function(){t.context.user&&!t.context.user.isModerator&&o()});break;case"toggle-trigger":e.addEventListener("cursordown",function(){l()});break;case"mod-toggle-trigger":e.addEventListener("cursordown",function(){t.context.user&&t.context.user.isModerator&&l()});break;case"no-mod-toggle-trigger":e.addEventListener("cursordown",function(){t.context.user&&!t.context.user.isModerator&&l()});break;case"enter-trigger":e.addEventListener("triggerenter",function(){o()});break;case"exit-trigger":e.addEventListener("triggerexit",function(){o()});break;case"mod-enter-trigger":e.addEventListener("triggerenter",function(){t.context.user&&t.context.user.isModerator&&o()});break;case"no-mod-enter-trigger":e.addEventListener("triggerenter",function(){t.context.user&&!t.context.user.isModerator&&o()});break;case"mod-exit-trigger":e.addEventListener("triggerexit",function(){t.context.user&&t.context.user.isModerator&&o()});break;case"no-mod-exit-trigger":e.addEventListener("triggerexit",function(){t.context.user&&!t.context.user.isModerator&&o()})}}),i.length&&e.addBehaviors.apply(e,i)}}class h{constructor(e){this.context=e}getVersion(){if(!this.context.currentScene)return;return this.context.currentScene.version||"1.0"}migrate(){switch(this.getVersion()){case"1.0":this.migrateV2()}}migrateV2(e){if(e=e||this.context.currentScene,this.context.currentScene===e&&(e.version="2.0"),e.settings.object){let t=e.settings.object.url,i=e.settings.object.mtl_url,r=e.settings.object.mtl_path;e.settings={name:e.settings.object.name,uuid:e.settings.object.uuid,type:e.settings.object.type,transform:e.settings.object.transform,behaviours:e.settings.altspace.behaviours,hide_on_mobile:e.settings.object.hide_on_mobile||!1,hide_on_desktop:e.settings.object.show_only_on_mobile||!1,geometry:e.settings.geometry,preserve_scale:!1,material:this.context.objectFactory.materialFactory.materialSettingsWithDefaults({type:"MeshBasicMaterial",visible:e.settings.material.visible,color:e.settings.material.color,transparent:e.settings.material.transparent,opacity:e.settings.material.opacity,map:e.settings.material.map,side:e.settings.material.side,fog:!1,lights:!1,texture:{wrapping:{s:e.settings.wrapping?e.settings.wrapping.s:THREE.RepeatWrapping,t:e.settings.wrapping?e.settings.wrapping.t:THREE.RepeatWrapping},repeat:{x:e.settings.material.repeatX?e.settings.material.repeatX:1,y:e.settings.material.repeatY?e.settings.material.repeatY:1},offset:{x:e.settings.material.offsetX?e.settings.material.offsetX:0,y:e.settings.material.offsetY?e.settings.material.offsetY:0},filters:{mag:e.settings.filters?e.settings.filters.mag:THREE.LinearFilter,min:e.settings.filters?e.settings.filters.min:THREE.LinearMipMapLinearFilter}},lightTexture:{wrapping:{s:THREE.RepeatWrapping,t:THREE.RepeatWrapping},repeat:{x:1,y:1},offset:{x:0,y:0},filters:{mag:THREE.LinearFilter,min:THREE.LinearMipMapLinearFilter}}}),state:{added:!1,updated:!1,transform_updated:!1,removed:!1}},t&&(e.settings.url=t),i&&(e.settings.mtl_url=i),r&&(e.settings.mtl_path=r)}e.children=e.children.filter(e=>e);for(let t=0;t<e.children.length;t++)e.children[t]&&this.migrateV2(e.children[t])}}i.d(t,"a",function(){return u});class u{constructor(e){this.context=e,this.migrations=new h(this),this.behaviourHelper=new r(this),this.objectFactory=new o(this),this.serialiser=new l(this),this.behaviourFactory=new c(this),this.currentScene={settings:this.objectFactory.defaultUserData(),children:[]},this.resetContainer(),this.containerComponentName="scene-graph-container",this.setupAframeContainer();let t=i(2).version;console.log("Shane's Editor Version "+t)}async load(e){return fetch(window.location.href+"/scene/"+e.short_code+".json").then(e=>e.json()).then(t=>(this.clearScene(),this.hasScene=!0,this.sceneLoaded=!1,this.currentScene=t||this.currentScene,this.migrations.migrate(),this.currentScene.metadata=e,console.log("Scene Downloaded."),Promise.resolve()))}canOpen(){return this.hasScene&&!this.sceneLoaded}dispatchLoadEvents(e){let t=0,i=e.length;for(let r=0;r<i;r++){e[r].then(()=>{t++,this.context.sceneEl.emit("scene-loading",t/i)})}}open(){if(console.log("Loading Scene..."),!this.currentScene||this.sceneLoaded)return;this.context.sceneEl.emit("scene-load-start"),this.sceneLoaded=!0;let e=this.serialiser.deSerialiseScene(this.currentScene);return this.dispatchLoadEvents(e),Promise.all(e)}setupAframeContainer(){let e=this;AFRAME.registerComponent(this.containerComponentName,{init(){this.el.setObject3D("mesh",e.container)}}),this.entityContainer=document.createElement("a-entity"),this.entityContainer.setAttribute("scene-graph-container",""),this.entityContainer.setAttribute("position","0 -1.6 0"),document.querySelector("a-scene").appendChild(this.entityContainer)}totals(e,t,i,r){let a=e.settings.hide_on_mobile,s=e.settings.hide_on_desktop;e.settings.stats&&(s||i?s=!0:(t.desktop.points+=e.settings.stats.points,t.desktop.pixels+=e.settings.stats.pixels),a||r?a=!0:(t.mobile.points+=e.settings.stats.points,t.mobile.pixels+=e.settings.stats.pixels));for(let i=0;i<e.children.length;i++)this.totals(e.children[i],t,s,a)}resetContainer(){this.container=new THREE.Object3D,this.currentScene.settings=this.objectFactory.defaultUserData(),this.currentScene.children.length=0,this.container.userData.sceneObject=this.currentScene}findByUUID(e,t,i){let r={},a=this;return"string"==typeof e&&(e=[e]),(i||this.container).traverse(function(i){i.userData.sceneObject&&e.indexOf(i.userData.sceneObject.uuid)>-1&&(r[i.userData.sceneObject.uuid]=t?JSON.stringify(a.scene_graph.serialiseScene(i)):i)}),1===e.length?r[e[0]]:r}remove(e,t){let i=e.children[t];if(i&&i.settings.uuid){let r=this.findByUUID(i.settings.uuid);r&&(r.parent.remove(r),this.clearObject(r)),e.children.splice(t,1)}}async add(e,t){if(this.context.cameraDummy){this.context.cameraDummy.object3D.position.set(0,0,-3),this.context.cameraDummy.object3D.updateMatrixWorld(),e.object3D.updateMatrixWorld();let i=this.context.cameraDummy.object3D.localToWorld(new THREE.Vector3(0,0,0));t.tra_settings={position:e.object3D.worldToLocal(i)}}let i={settings:this.objectFactory.generateUserData(t),children:[]};return this.objectFactory.make(i).then(t=>(t.userData.sceneObject=i,i.object3D=t,i.parent=e,e.object3D.add(t),e.children.push(i),i))}clearObject(e){e.traverse(e=>{if(e.material&&e.material.map&&e.material.map.dispose&&(e.material.map.dispose(),e.material.dispose&&e.material.dispose()),e.material&&e.material.length)for(let t=0;t<e.material.length;t++)e.material[t].map&&e.material[t].map.dispose&&e.material[t].map.dispose();e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()})}clearScene(){this.hasScene=!1,this.clearObject(this.container),this.resetContainer(),this.entityContainer.setObject3D("mesh",this.container)}}},2:function(e){e.exports={name:"shanes-editor",version:"2.0.6",description:"",main:"index.js",private:!0,scripts:{start:"webpack-dev-server","start-server":"webpack-dev-server",build:"webpack --mode production"},author:"",license:"ISC",devDependencies:{concurrently:"^3.6.0","copy-webpack-plugin":"^4.5.2",nodemon:"^1.18.3",webpack:"^4.16.1","webpack-cli":"^3.1.0","webpack-dev-server":"^3.1.4","worker-loader":"^2.0.0"},dependencies:{handlebars:"^4.0.11"}}},3:function(e,t){var i=AFRAME.utils.bind,r=AFRAME.utils.device.PolyfillControls,a=Math.PI/2,s=AFRAME.utils.device.checkHasPositionalTracking;AFRAME.registerComponent("right-look-controls",{dependencies:["position","rotation"],schema:{enabled:{default:!0},hmdEnabled:{default:!0},pointerLockEnabled:{default:!1},reverseMouseDrag:{default:!1},touchEnabled:{default:!0}},init:function(){this.previousHMDPosition=new THREE.Vector3,this.hmdQuaternion=new THREE.Quaternion,this.hmdEuler=new THREE.Euler,this.position=new THREE.Vector3,this.savedRotation=new THREE.Vector3,this.savedPosition=new THREE.Vector3,this.polyfillObject=new THREE.Object3D,this.polyfillControls=new r(this.polyfillObject),this.rotation={},this.deltaRotation={},this.savedPose=null,this.pointerLocked=!1,this.setupMouseControls(),this.bindMethods(),this.savedPose={position:new THREE.Vector3,rotation:new THREE.Euler},this.el.sceneEl.is("vr-mode")&&this.onEnterVR(),document.addEventListener("contextmenu",e=>{e.preventDefault()},!1)},update:function(e){var t=this.data;t.enabled!==e.enabled&&this.updateGrabCursor(t.enabled),!e||t.hmdEnabled||e.hmdEnabled||(this.pitchObject.rotation.set(0,0,0),this.yawObject.rotation.set(0,0,0)),e&&!t.pointerLockEnabled!==e.pointerLockEnabled&&(this.removeEventListeners(),this.addEventListeners(),this.pointerLocked&&document.exitPointerLock())},tick:function(e){this.data.enabled&&this.updateOrientation()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners()},remove:function(){this.removeEventListeners()},bindMethods:function(){this.onMouseDown=i(this.onMouseDown,this),this.onMouseMove=i(this.onMouseMove,this),this.onMouseUp=i(this.onMouseUp,this),this.onTouchStart=i(this.onTouchStart,this),this.onTouchMove=i(this.onTouchMove,this),this.onTouchEnd=i(this.onTouchEnd,this),this.onEnterVR=i(this.onEnterVR,this),this.onExitVR=i(this.onExitVR,this),this.onPointerLockChange=i(this.onPointerLockChange,this),this.onPointerLockError=i(this.onPointerLockError,this)},setupMouseControls:function(){this.mouseDown=!1,this.pitchObject=new THREE.Object3D,this.yawObject=new THREE.Object3D,this.yawObject.position.y=10,this.yawObject.add(this.pitchObject)},addEventListeners:function(){var e=this.el.sceneEl,t=e.canvas;t?(t.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("mousemove",this.onMouseMove,!1),window.addEventListener("mouseup",this.onMouseUp,!1),t.addEventListener("touchstart",this.onTouchStart),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("touchend",this.onTouchEnd),e.addEventListener("enter-vr",this.onEnterVR),e.addEventListener("exit-vr",this.onExitVR),this.data.pointerLockEnabled&&(document.addEventListener("pointerlockchange",this.onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this.onPointerLockChange,!1),document.addEventListener("pointerlockerror",this.onPointerLockError,!1))):e.addEventListener("render-target-loaded",i(this.addEventListeners,this))},removeEventListeners:function(){var e=this.el.sceneEl,t=e&&e.canvas;t&&(t.removeEventListener("mousedown",this.onMouseDown),window.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("mouseup",this.onMouseUp),t.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("enter-vr",this.onEnterVR),e.removeEventListener("exit-vr",this.onExitVR),document.removeEventListener("pointerlockchange",this.onPointerLockChange,!1),document.removeEventListener("mozpointerlockchange",this.onPointerLockChange,!1),document.removeEventListener("pointerlockerror",this.onPointerLockError,!1))},updateOrientation:function(){var e=this.el,t=this.hmdEuler,i=this.pitchObject,r=this.yawObject,a=this.el.sceneEl;a.is("vr-mode")&&a.checkHeadsetConnected()||(this.polyfillControls.update(),t.setFromQuaternion(this.polyfillObject.quaternion,"YXZ"),e.object3D.rotation.x=t.x+i.rotation.x,e.object3D.rotation.y=t.y+r.rotation.y)},onMouseMove:function(e){var t,i,r,s=this.pitchObject,n=this.previousMouseEvent,o=this.yawObject;this.data.enabled&&(this.mouseDown||this.pointerLocked)&&(this.pointerLocked?(i=e.movementX||e.mozMovementX||0,r=e.movementY||e.mozMovementY||0):(i=e.screenX-n.screenX,r=e.screenY-n.screenY),this.previousMouseEvent=e,t=this.data.reverseMouseDrag?1:-1,o.rotation.y+=.002*i*t,s.rotation.x+=.002*r*t,s.rotation.x=Math.max(-a,Math.min(a,s.rotation.x)))},onMouseDown:function(e){if(this.data.enabled&&2===e.button){var t=this.el.sceneEl,i=t&&t.canvas;this.mouseDown=!0,this.previousMouseEvent=e,document.body.classList.add("a-grabbing"),this.data.pointerLockEnabled&&!this.pointerLocked&&(i.requestPointerLock?i.requestPointerLock():i.mozRequestPointerLock&&i.mozRequestPointerLock())}},onMouseUp:function(){this.mouseDown=!1,this.el.emit("stopped"),document.body.classList.remove("a-grabbing")},onTouchStart:function(e){1===e.touches.length&&this.data.touchEnabled&&(this.touchStart={x:e.touches[0].pageX,y:e.touches[0].pageY},this.touchStarted=!0)},onTouchMove:function(e){var t,i=this.el.sceneEl.canvas,r=this.yawObject;this.touchStarted&&this.data.touchEnabled&&(t=2*Math.PI*(e.touches[0].pageX-this.touchStart.x)/i.clientWidth,r.rotation.y-=.5*t,this.touchStart={x:e.touches[0].pageX,y:e.touches[0].pageY})},onTouchEnd:function(){this.touchStarted=!1},onEnterVR:function(){this.saveCameraPose()},onExitVR:function(){this.restoreCameraPose(),this.previousHMDPosition.set(0,0,0)},onPointerLockChange:function(){this.pointerLocked=!(!document.pointerLockElement&&!document.mozPointerLockElement)},onPointerLockError:function(){this.pointerLocked=!1},updateGrabCursor:function(e){var t=this.el.sceneEl;function i(){t.canvas.classList.add("a-grab-cursor")}function r(){t.canvas.classList.remove("a-grab-cursor")}t.canvas?e?i():r():e?t.addEventListener("render-target-loaded",i):t.addEventListener("render-target-loaded",r)},saveCameraPose:function(){var e=this.el,t=void 0!==this.hasPositionalTracking?this.hasPositionalTracking:s();!this.hasSavedPose&&t&&(this.savedPose.position.copy(e.object3D.position),this.savedPose.rotation.copy(e.object3D.rotation),this.hasSavedPose=!0)},restoreCameraPose:function(){var e=this.el,t=this.savedPose,i=void 0!==this.hasPositionalTracking?this.hasPositionalTracking:s();this.hasSavedPose&&i&&(e.object3D.position.copy(t.position),e.object3D.rotation.copy(t.rotation),this.hasSavedPose=!1)}})},55:function(e,t,i){"use strict";i.r(t);var r=i(1),a=i(0);i(3);document.addEventListener("DOMContentLoaded",()=>{window.renderer=new class{constructor(){this.namer=new a.a,this.sceneGraph=new r.a(this),this.sceneEl=document.querySelector("a-scene"),this.setupLoadingSphere(),this.loadScene()}loadScene(){let e=this.getParameterByName("code");e&&(console.log("Connecting to room:",e),this.sceneEl.setAttribute("networked-scene",{serverURL:"https://shanesedit.org:8087",room:e,adapter:"easyrtc",audio:!0,debug:!0}),this.sceneGraph.load({short_code:e}).then(()=>this.sceneGraph.open()))}setupLoadingSphere(){let e=document.getElementById("camera");this.loadingSphere=new THREE.Mesh(new THREE.SphereGeometry(.2),new THREE.MeshBasicMaterial({color:"#fff",side:THREE.BackSide}));let t=document.getElementById("loadingText"),i=document.getElementById("loadingLogo"),r=(new Date).getTime();e.object3D.add(this.loadingSphere),this.sceneEl.addEventListener("scene-loading",e=>{if(t.setAttribute("value",Math.round(100*e.detail)+"%"),1===e.detail){console.log("Scene loaded in: "+((new Date).getTime()-r)/1e3+"s");let e=this;new TWEEN.Tween({x:1}).to({x:0},250).onUpdate(function(){i.setAttribute("scale",this.x+" "+this.x+" "+this.x)}).onComplete(()=>{i.parentElement.removeChild(i)}).easing(TWEEN.Easing.Exponential.Out).start(),new TWEEN.Tween({x:1}).delay(250).to({x:0},250).onUpdate(function(){t.setAttribute("scale",this.x+" "+this.x+" "+this.x),i.setAttribute("scale",this.x+" "+this.x+" "+this.x)}).onComplete(()=>{t.parentElement.removeChild(t),this.loadingSphere.material.transparent=!0,new TWEEN.Tween({x:1}).to({x:0},750).onUpdate(function(){e.loadingSphere.material.opacity=this.x}).onComplete(()=>e.loadingSphere.parent.remove(e.loadingSphere)).easing(TWEEN.Easing.Exponential.Out).start()}).easing(TWEEN.Easing.Exponential.Out).start()}})}getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");let i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}}})}});